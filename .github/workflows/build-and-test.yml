name: Build and Test

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup Visual Studio Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
    
    - name: Build icon generator
      run: |
        echo "Building icon generator..."
        cl /std:c++17 /EHsc resources\icon\create-icon.cpp /Fe:resources\icon\create-icon.exe /link gdi32.lib user32.lib
        
    - name: Generate icons
      run: |
        echo "Generating icon files..."
        cd resources\icon
        .\create-icon.exe
        cd ..\..
        
    - name: Compile resources
      run: |
        echo "Compiling resources..."
        rc /fo resources\app-resource.res resources\app-resource.rc
        
    - name: Build application
      run: |
        echo "Building ArhintSigner Web Service..."
        mkdir release -Force
        cl /std:c++17 /EHsc /O2 /W3 /I"src/include" src\arhint-signer.cpp resources\app-resource.res /Fe:release\arhint-signer.exe /link /SUBSYSTEM:WINDOWS /ENTRY:WinMainCRTStartup httpapi.lib crypt32.lib ncrypt.lib ws2_32.lib advapi32.lib shell32.lib user32.lib
        
    - name: Verify build output
      run: |
        if (Test-Path "release\arhint-signer.exe") {
          echo "✅ Build successful: arhint-signer.exe created"
          $fileInfo = Get-Item "release\arhint-signer.exe"
          echo "File size: $($fileInfo.Length) bytes"
          echo "Created: $($fileInfo.CreationTime)"
        } else {
          echo "❌ Build failed: arhint-signer.exe not found"
          exit 1
        }
        
    - name: Reserve HTTP URL
      run: |
        echo "Reserving HTTP URL..."
        # Delete existing reservation if present
        netsh http delete urlacl url=http://+:8082/ 2>$null
        # Add new reservation for the current user and NETWORK SERVICE
        netsh http add urlacl url=http://+:8082/ user=Everyone
        echo "✅ HTTP URL reserved successfully"
        
    - name: Start web service
      id: start_service
      run: |
        echo "Starting ArhintSigner web service..."
        
        # Start the service with a console window to capture output
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = "release\arhint-signer.exe"
        $psi.Arguments = "8082"
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        $psi.UseShellExecute = $false
        $psi.CreateNoWindow = $true
        
        $process = [System.Diagnostics.Process]::Start($psi)
        
        # Start async readers
        $outputBuilder = New-Object System.Text.StringBuilder
        $errorBuilder = New-Object System.Text.StringBuilder
        
        $outputEvent = Register-ObjectEvent -InputObject $process -EventName OutputDataReceived -Action {
          if ($EventArgs.Data) {
            $Event.MessageData.AppendLine($EventArgs.Data)
          }
        } -MessageData $outputBuilder
        
        $errorEvent = Register-ObjectEvent -InputObject $process -EventName ErrorDataReceived -Action {
          if ($EventArgs.Data) {
            $Event.MessageData.AppendLine($EventArgs.Data)
          }
        } -MessageData $errorBuilder
        
        $process.BeginOutputReadLine()
        $process.BeginErrorReadLine()
        
        echo "SERVICE_PID=$($process.Id)" >> $env:GITHUB_OUTPUT
        echo "✅ Service started with PID: $($process.Id)"
        
        # Wait for service to be ready
        echo "Waiting for service to initialize..."
        $maxAttempts = 20
        $attempt = 0
        $serviceReady = $false
        
        while ($attempt -lt $maxAttempts -and -not $serviceReady) {
          Start-Sleep -Seconds 1
          $attempt++
          
          # Check if process is still running
          if ($process.HasExited) {
            echo "❌ Service process has exited unexpectedly with code: $($process.ExitCode)"
            echo "=== Standard Output ==="
            echo $outputBuilder.ToString()
            echo "=== Standard Error ==="
            echo $errorBuilder.ToString()
            Unregister-Event -SourceIdentifier $outputEvent.Name
            Unregister-Event -SourceIdentifier $errorEvent.Name
            exit 1
          }
          
          # Check if port is listening
          $listening = Get-NetTCPConnection -LocalPort 8082 -State Listen -ErrorAction SilentlyContinue
          if ($listening -and $attempt -eq 1) {
            echo "✅ Port 8082 is now listening"
          }
          
          # Try multiple methods to connect
          $urls = @("http://localhost:8082/health", "http://127.0.0.1:8082/health")
          foreach ($url in $urls) {
            try {
              # Try with curl first (more reliable on Windows)
              $curlResult = curl.exe -s -w "%{http_code}" -o nul $url 2>&1
              if ($curlResult -eq "200") {
                $serviceReady = $true
                echo "✅ Service is ready after $attempt seconds (tested with curl on $url)"
                break
              }
            } catch {
              # Try Invoke-WebRequest as fallback
              try {
                $response = Invoke-WebRequest -Uri $url -Method GET -UseBasicParsing -TimeoutSec 2 -ErrorAction SilentlyContinue
                if ($response.StatusCode -eq 200) {
                  $serviceReady = $true
                  echo "✅ Service is ready after $attempt seconds (tested with Invoke-WebRequest on $url)"
                  break
                }
              } catch {
                # Continue to next URL
              }
            }
          }
          
          if ($serviceReady) {
            break
          }
          
          if ($attempt % 5 -eq 0) {
            echo "Attempt $attempt/$maxAttempts - Still waiting..."
            echo "Output so far: $($outputBuilder.ToString())"
          }
        }
        
        if (-not $serviceReady) {
          echo "❌ Service failed to start within $maxAttempts seconds"
          echo "Process status: Running=$(-not $process.HasExited), PID=$($process.Id)"
          echo "=== Standard Output ==="
          echo $outputBuilder.ToString()
          echo "=== Standard Error ==="
          echo $errorBuilder.ToString()
          
          # Check HTTP.sys URL reservations
          echo "=== HTTP.sys URL Reservations ==="
          netsh http show urlacl | Select-String -Pattern "8082" -Context 2,2
          
          # Try one more time with detailed curl output
          echo "=== Final connection test with curl ==="
          curl.exe -v http://localhost:8082/health 2>&1
          
          Unregister-Event -SourceIdentifier $outputEvent.Name
          Unregister-Event -SourceIdentifier $errorEvent.Name
          exit 1
        }
        
        Unregister-Event -SourceIdentifier $outputEvent.Name
        Unregister-Event -SourceIdentifier $errorEvent.Name
        
    - name: Test health endpoint
      run: |
        echo "Testing health endpoint..."
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:8082/health" -Method GET -UseBasicParsing
          echo "Status Code: $($response.StatusCode)"
          echo "Response: $($response.Content)"
          
          if ($response.StatusCode -eq 200) {
            echo "✅ Health check passed"
          } else {
            echo "❌ Health check failed with status code: $($response.StatusCode)"
            exit 1
          }
        } catch {
          echo "❌ Health check failed: $_"
          exit 1
        }
        
    - name: Test certificates endpoint
      run: |
        echo "Testing certificates endpoint..."
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:8082/certificates" -Method GET -UseBasicParsing
          echo "Status Code: $($response.StatusCode)"
          $json = $response.Content | ConvertFrom-Json
          
          if ($response.StatusCode -eq 200 -and $json.certificates) {
            echo "✅ Certificates endpoint working"
            echo "Found $($json.certificates.Count) certificates"
          } else {
            echo "⚠️ Certificates endpoint returned unexpected response"
          }
        } catch {
          echo "❌ Certificates endpoint test failed: $_"
          exit 1
        }
        
    - name: Test sign endpoint (should fail without valid input)
      run: |
        echo "Testing sign endpoint with invalid data..."
        try {
          $headers = @{
            "Content-Type" = "application/json"
          }
          $body = @{
            hash = ""
            thumbprint = ""
          } | ConvertTo-Json
          
          $response = Invoke-WebRequest -Uri "http://localhost:8082/sign" -Method POST -Headers $headers -Body $body -UseBasicParsing
          
          if ($response.StatusCode -eq 400) {
            echo "✅ Sign endpoint correctly rejected invalid input"
          } else {
            echo "⚠️ Sign endpoint returned unexpected status: $($response.StatusCode)"
          }
        } catch {
          $statusCode = $_.Exception.Response.StatusCode.value__
          if ($statusCode -eq 400) {
            echo "✅ Sign endpoint correctly rejected invalid input (400)"
          } else {
            echo "❌ Sign endpoint test failed: $_"
            exit 1
          }
        }
        
    - name: Test CORS headers
      run: |
        echo "Testing CORS headers..."
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:8082/health" -Method GET -UseBasicParsing
          $corsHeader = $response.Headers["Access-Control-Allow-Origin"]
          
          if ($corsHeader -eq "*") {
            echo "✅ CORS headers present and correct"
          } else {
            echo "⚠️ CORS header missing or incorrect: $corsHeader"
          }
        } catch {
          echo "❌ CORS test failed: $_"
          exit 1
        }
        
    - name: Stop web service
      if: always()
      run: |
        echo "Stopping web service..."
        $servicePid = "${{ steps.start_service.outputs.SERVICE_PID }}"
        if ($servicePid) {
          try {
            Stop-Process -Id $servicePid -Force -ErrorAction SilentlyContinue
            echo "✅ Service stopped"
          } catch {
            echo "⚠️ Service may have already stopped"
          }
        }
        
    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: arhint-signer-build
        path: |
          release/arhint-signer.exe
          examples/example-arhint-signer.html
        retention-days: 30
        
    - name: Test cleanup
      if: always()
      run: |
        echo "Cleaning up test resources..."
        # Kill any remaining processes
        Get-Process | Where-Object { $_.ProcessName -eq "arhint-signer" } | Stop-Process -Force -ErrorAction SilentlyContinue
        echo "✅ Cleanup complete"
